import { ProcessedResult, FilterOptions } from '../types';

interface VulnerabilityModelData {
  primevul?: {
    accuracy?: number;
    precision?: number;
    recall?: number;
    f1?: number;
    [key: string]: number | undefined;
  };
  primevul_pair?: (number | Record<string, number>)[];
  diversevul?: {
    accuracy?: number;
    precision?: number;
    recall?: number;
    f1?: number;
    [key: string]: number | undefined;
  };
  [key: string]: unknown;
}

export async function processVulnerabilityDetection(rawData: ProcessedResult[], filters: FilterOptions): Promise<ProcessedResult[]> {
  console.log('Processing vulnerability detection task:', {
    totalData: rawData.length,
    filters
  });

  // 尝试加载漏洞检测的JSON数据
  let vulDetectionData: Record<string, VulnerabilityModelData> = {};
  try {
    // 使用API从服务器获取数据
    const response = await fetch('/api/files?directory=data/vulnerability-detection&file=detect_score.json');
    if (response.ok) {
      vulDetectionData = await response.json();
      console.log('Loaded vulnerability detection data:', Object.keys(vulDetectionData).length, 'models');
    } else {
      console.warn('Failed to load vulnerability detection data from API, status:', response.status);
      return [];
    }
  } catch (error) {
    console.error('Failed to load vulnerability detection data:', error);
    return [];
  }

  // 转换数据格式，生成ProcessedResult数组
  const results: ProcessedResult[] = [];
  
  // 遍历每个模型的数据
  Object.entries(vulDetectionData).forEach(([modelName, modelData]: [string, VulnerabilityModelData]) => {
    // 为PrimeVul数据集创建结果
    if (modelData.primevul) {
      const primeVulResult: ProcessedResult = {
        modelId: modelName,
        modelName: modelName,
        dataset: 'PrimeVul',
        task: 'vulnerability detection',
        sourceLang: null,
        lang: 'Multiple',
        targetLang: null,
        // 初始化所有指标为null
        pass1: null,
        pass3: null,
        pass5: null,
        executionAccuracy: null,
        // 空的难度指标
        easyPass1: null,
        easyPass3: null,
        easyPass5: null,
        mediumPass1: null,
        mediumPass3: null,
        mediumPass5: null,
        hardPass1: null,
        hardPass3: null,
        hardPass5: null,
        codebleu: null,
        llmjudge: null,
        difficulty: null,
        // PrimeVul指标
        'Accuracy': modelData.primevul.accuracy !== null && modelData.primevul.accuracy !== undefined ? modelData.primevul.accuracy : null,
        'Precision': modelData.primevul.precision !== null && modelData.primevul.precision !== undefined ? modelData.primevul.precision : null,
        'Recall': modelData.primevul.recall !== null && modelData.primevul.recall !== undefined ? modelData.primevul.recall : null,
        'F1 Score': modelData.primevul.f1 !== null && modelData.primevul.f1 !== undefined ? modelData.primevul.f1 : null,
      };
      results.push(primeVulResult);
    }
    
    // 为PrimeVulPairs数据集创建结果
    if (modelData.primevul_pair && modelData.primevul_pair.length > 1) {
      const pairStats = modelData.primevul_pair[1] as Record<string, number>; // 使用百分比数据
      const primeVulPairsResult: ProcessedResult = {
        modelId: modelName,
        modelName: modelName,
        dataset: 'PrimeVulPairs',
        task: 'vulnerability detection',
        sourceLang: null,
        lang: 'Multiple',
        targetLang: null,
        // 初始化所有指标为null
        pass1: null,
        pass3: null,
        pass5: null,
        executionAccuracy: null,
        // 空的难度指标
        easyPass1: null,
        easyPass3: null,
        easyPass5: null,
        mediumPass1: null,
        mediumPass3: null,
        mediumPass5: null,
        hardPass1: null,
        hardPass3: null,
        hardPass5: null,
        codebleu: null,
        llmjudge: null,
        difficulty: null,
        // PrimeVulPairs指标
        'P-C': pairStats['P-C'] !== null && pairStats['P-C'] !== undefined ? pairStats['P-C'] : null,
        'P-V': pairStats['P-V'] !== null && pairStats['P-V'] !== undefined ? pairStats['P-V'] : null,
        'P-B': pairStats['P-B'] !== null && pairStats['P-B'] !== undefined ? pairStats['P-B'] : null,
        'P-R': pairStats['P-R'] !== null && pairStats['P-R'] !== undefined ? pairStats['P-R'] : null,
      };
      results.push(primeVulPairsResult);
    }
  });
  
  console.log('生成的漏洞检测结果:', {
    totalResults: results.length,
    datasets: [...new Set(results.map(r => r.dataset))],
    sampleResult: results[0]
  });

  // 应用过滤器
  let filteredResults = [...results];
  
  // 数据集过滤
  if (filters.datasets && filters.datasets.length > 0) {
    // 规范化数据集名称：转换为小写并移除所有空格
    const selectedDatasets = new Set(filters.datasets.map(d => d.toLowerCase().replace(/\s+/g, '')));
    console.log('应用漏洞检测数据集过滤:', {
      selectedDatasets: Array.from(selectedDatasets),
      totalResultsBefore: filteredResults.length,
      originalDatasets: filters.datasets
    });
    
    // 使用相同的规范化方法过滤数据集
    filteredResults = filteredResults.filter(result => {
      const normalizedDataset = result.dataset.toLowerCase().replace(/\s+/g, '');
      const isIncluded = selectedDatasets.has(normalizedDataset);
      if (filteredResults.length <= 10) { // Only log for debugging first few items
        console.log(`检查数据集匹配: ${result.dataset} -> ${normalizedDataset} = ${isIncluded}`);
      }
      return isIncluded;
    });
    
    console.log('过滤后的漏洞检测结果:', {
      totalResults: filteredResults.length,
      remainingDatasets: [...new Set(filteredResults.map(r => r.dataset))]
    });
  }

  return filteredResults;
}

export function aggregateVulnerabilityDetectionResults(results: ProcessedResult[]): ProcessedResult[] {
  // 如果没有结果，直接返回空数组
  if (results.length === 0) return [];

  // 按模型名称分组
  const groupedByModel = new Map<string, ProcessedResult[]>();
  
  results.forEach(result => {
    if (!groupedByModel.has(result.modelName)) {
      groupedByModel.set(result.modelName, []);
    }
    groupedByModel.get(result.modelName)!.push(result);
  });
  
  // 合并每个模型的所有数据集结果
  return Array.from(groupedByModel.entries()).map(([modelName, modelResults]) => {
    console.log(`聚合${modelName}的漏洞检测结果:`, {
      totalResults: modelResults.length,
      datasets: modelResults.map(r => r.dataset)
    });
    
    // 创建基础结果对象
    const aggregatedResult: ProcessedResult = {
      modelId: modelName,
      modelName: modelName,
      dataset: modelResults.map(r => r.dataset).join(', '),
      task: 'vulnerability detection',
      sourceLang: null,
      lang: 'Multiple',
      targetLang: null,
      pass1: null,
      pass3: null,
      pass5: null,
      executionAccuracy: null,
      easyPass1: null,
      easyPass3: null,
      easyPass5: null,
      mediumPass1: null,
      mediumPass3: null,
      mediumPass5: null,
      hardPass1: null,
      hardPass3: null,
      hardPass5: null,
      codebleu: null,
      llmjudge: null,
      difficulty: null
    } as ProcessedResult;

    // 合并所有数据集的指标
    modelResults.forEach(result => {
      // 复制所有非空的指标
      Object.entries(result).forEach(([key, value]) => {
        if (value !== null && 
            ['P-C', 'P-V', 'P-B', 'P-R', 'Accuracy', 'Precision', 'Recall', 'F1 Score'].includes(key)) {
          (aggregatedResult as Record<string, unknown>)[key] = value;
        }
      });
    });
    
    return aggregatedResult;
  });
}